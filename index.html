<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Lyric Writing Tool</title>
    <!-- Include Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css">
    <style>
    /* Highlight classes */
    .highlight1 {
        background-color: #ffffd3;
    }
    .highlight2 {
        background-color: #dbffdb;
    }

    /* Container for the textarea and highlighted text */
    .textarea-container {
        position: relative;
        height: calc(100vh - 150px); /* Adjust as needed */
        min-height: 1650px;
        border: 1px solid #ccc;
        display: flex; /* Use flex to align items */
        overflow: hidden; /* Prevent double scrollbars */
    }

    /* Shared styles for both the textarea and the highlighted text */
    #lyric-input,
    #highlighted-text {
        position: absolute;
        top: 0;
        left: 50px; /* Adjust left position to accommodate line counts */
        width: calc(100% - 50px); /* Adjust width accordingly */
        height: 100%;
        padding: 10px;
        overflow-y: auto;
        overflow-x: auto;  
        font-family: Arial, sans-serif; /* Use your preferred font */
        font-size: 16px;
        line-height: 1.2;
        box-sizing: border-box;
        background-color: transparent;
        border: none;
        outline: none;
        white-space: pre;       /* Change from pre-wrap to pre */
        word-wrap: normal;      /* Disable word wrapping */
        overflow-wrap: normal;  /* Disable overflow wrapping */
        overflow-x: auto;       /* Enable horizontal scrolling */
    }

    /* Specific styles for the textarea */
    #lyric-input {
        resize: none;
        color: transparent; /* Hide the text */
        caret-color: black; /* Show the cursor */
        spellcheck: false;  /* Disable spell check */
    }

    /* Specific styles for the highlighted text */
    #highlighted-text {
        pointer-events: none; /* Makes the div non-interactive */
    }

    /* Hide scrollbar for highlighted-text div */
    #highlighted-text::-webkit-scrollbar {
        display: none;
    }
    #highlighted-text {
        -ms-overflow-style: none;  /* IE and Edge */
        scrollbar-width: none;     /* Firefox */
    }

    /* Other styles */
    .tag-cell {
        color: black;
        text-decoration: none;
        min-width: 200px;
        width: 230px;
        font-weight: 500;
    }

    #rhymes-list {
        height: 200px;
        overflow-y: auto;
        border: 1px solid #ccc;
        padding: 5px;
    }

    .separator {
        border-top: 1px solid #dee2e6;
        margin: 1.5rem 0;
    }

    #rhymes-list ol {
        counter-reset: item;
    }
    #rhymes-list ol li {
        display: block;
    }
    #rhymes-list ol li:before {
        content: counter(item) ". ";
        counter-increment: item;
        color: #bcbcbc;
    }

    /* Slider styling */
    .slider-container {
        margin-top: 10px;
    }
    .slider-container label {
        font-weight: bold;
    }

    /* Blacklist highlighting */
    .highlight-blacklist {
        color: red;
        /* font-weight: bold; */
    }
    #rhymes-list a {
        color: #212529 !important;
    }
    /* Line Word Counts */
    #line-word-counts {
        position: relative;
        width: 50px; /* Adjust the width as needed */
        padding: 10px 5px 10px 0;
        overflow: hidden;
        text-align: right;
        font-family: Arial, sans-serif; /* Match the textarea font */
        font-size: 16px;
        line-height: 1.2;
        box-sizing: border-box;
        border-right: 1px solid #ccc;
        background-color: #f9f9f9;
        color: #555;
        white-space: pre-wrap;
    }

    #line-word-counts .line-count {
        height: 1.2em; /* Match the line height */
        color: #afafaf;
    }

    /* Adjust the scrollbars */
    #lyric-input,
    #highlighted-text {
        scrollbar-width: none; /* Firefox */
    }

    #lyric-input::-webkit-scrollbar,
    #highlighted-text::-webkit-scrollbar {
        display: none; /* Hide scrollbar for WebKit browsers */
    }

    /* Adjusted styles for the tag popup */
    #tag-popup {
        max-width: 550px;
        width: 430px;
        max-height: 408px;
        overflow-y: auto;
        overflow-x: hidden;
    }

    /* Make the popup header sticky */
    #tag-popup .card-header {
        position: sticky;
        top: 0;
        z-index: 1;
        background-color: white;
    }

    /* Custom styles for hover and active states */
    .list-group-item-action:hover {
        background-color: #f5f5f5;
    }

    .list-group-item.tag-active {
        background-color: #007bff;
        color: white;
    }

    /* Ensure the tag popup header is not overlapped */
    #tag-popup {
        overflow: hidden;
    }

    #tag-popup .list-group {
        max-height: 350px; /* Adjust as needed */
        overflow-y: auto;
    }

    #tag-popup .card-header {
        position: sticky;
        top: 0;
        z-index: 1;
        background-color: white;
    }
    </style>
</head>
<body class="bg-light">
    <div class="container mt-5">
        <div class="card shadow-sm">
            <div class="card-body">
                <div class="row">
                    <!-- First Column: Text Area -->
                    <div class="col-md-8">
                        <div class="textarea-container">
                            <!-- Line Word Counts -->
                            <div id="line-word-counts"></div>
                            <!-- Highlighted Text -->
                            <div id="highlighted-text"></div>
                            <!-- Textarea Input -->
                            <textarea id="lyric-input" placeholder="Write your lyrics here..." spellcheck="false"></textarea>
                        </div>

                        <!-- Tag Selection Popup -->
                        <div id="tag-popup" class="card" style="display:none; position:absolute; z-index:1000;">
                            <!--<div class="card-header py-2 d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">Tags</h5>
                                <button type="button" id="tag-popup-close" class="close">&times;</button>
                            </div>-->
                            <ul id="tag-list" class="list-group list-group-flush">
                                <!-- Tag items will be added here -->
                            </ul>
                        </div>

                        <!-- Word and Letter Counter + Spell check-->
                        <div class="d-flex justify-content-between align-items-center mt-2">
                          <div id="counter">
                            Words: <span id="word-count">0</span> | Letters: <span id="letter-count">0</span>
                          </div>
                          <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="spellcheck-toggle">
                            <label class="form-check-label" for="spellcheck-toggle">Spell Check</label>
                          </div>
                        </div>
                    </div>
                    <!-- Second Column: Settings -->
                    <div class="col-md-4">
                        <!-- Title and Prompt Inputs -->
                        <div>
                            <div class="form-group">
                                <label for="title-input">Title</label>
                                <input type="text" id="title-input" class="form-control" placeholder="Enter song title">
                            </div>
                            <div class="form-group">
                                <label for="prompt-input">Prompt</label>
                                <input type="text" id="prompt-input" class="form-control" placeholder="Enter song prompt">
                            </div>
                            <!-- Save/Load Section -->
                            <div>
                                <button id="save-btn" class="btn btn-primary mb-2">Save</button>
                                <button id="load-btn" class="btn btn-secondary mb-2 ml-2">Load</button>
                                <!-- Hidden file input -->
                                <input type="file" id="load-input" accept=".json" style="display: none;">
                            </div>
                        </div>
                        <!-- Text-to-speech -->
                        <div class="separator"></div>
                        <h5 class="text-center" data-toggle="tooltip" data-placement="top" title="This tool convert text to speech using your selected language and voice options. The available voices may vary based on your browser; for the best experience, I recommend using Microsoft Edge.">Text-to-speech</h5>
                        <div>
                            <!-- Language Selection Dropdown -->
                            <div class="form-group">
                                <label for="languageSelect">Select Language</label>
                                <select id="languageSelect" class="form-control"></select>
                            </div>

                            <!-- Voice Selection Dropdown -->
                            <div class="form-group">
                                <label for="voiceSelect">Select Voice</label>
                                <select id="voiceSelect" class="form-control"></select>
                            </div>

                            <!-- Speech Rate Slider -->
                            <div class="form-group">
                                <label for="rateControl">Speech Rate (Tempo)</label>
                                <input type="range" id="rateControl" class="form-control-range" min="0.1" max="2" step="0.1" value="1">
                                <span id="rateValue">1.0</span>
                            </div>

                            <!-- Speak and Cancel Buttons -->
                            <div class="form-group">
                                <button class="btn btn-primary" onclick="speakText()">Speak</button>
                                <button class="btn btn-danger" id="cancelButton" onclick="cancelSpeech()" disabled>Cancel</button>
                            </div>

                            <!-- Status Display -->
                            <p id="status" class=""></p>
                        </div>
                        <div class="separator"></div>

                        <!-- Duration and Tempo -->
                        <div>
                            <h5 class="text-center" data-toggle="tooltip" data-placement="top" title="This tool helps you gauge how much text can be sung, depending on the song's duration and tempo. Keep in mind that adding tags will impact how much fits into each section.">Chunk highlighting</h5>
                            <!-- Duration Dropdown -->
                            <div class="form-group">
                                <label for="duration-select">Duration</label>
                                <select id="duration-select" class="form-control">
                                    <option value="32">32 seconds</option>
                                    <option value="130">130 seconds</option>
                                </select>
                            </div>
                            <!-- Tempo Dropdown -->
                            <div class="form-group">
                                <label for="tempo-select">Tempo</label>
                                <select id="tempo-select" class="form-control">
                                    <option value="slow">Slow Tempo (~60 BPM)</option>
                                    <option value="mid">Mid Tempo (~100 BPM)</option>
                                    <option value="fast">Fast Tempo (~140 BPM)</option>
                                </select>
                            </div>
                            <!-- Prompt/Genre Suggestions -->
                            <div id="suggestions" class="mt-3">
                                <!-- Suggestions will be inserted here -->
                            </div>
                        </div>
                        <div class="separator"></div>
                        <!-- Rhyme Finder -->
                        <div>
                            <h5 class="text-center" data-toggle="tooltip" data-placement="top" title="A tool that helps you find words with similar endings.">Rhyme finder</h5>
                            <div class="form-group">
                                <label for="rhyme-input">Find Rhymes</label>
                                <input type="text" id="rhyme-input" class="form-control" placeholder="Enter a word">
                                <label for="ending-select" class="mt-2">Match ending letters:</label>
                                <select id="ending-select" class="form-control">
                                    <option value="2">2 letters</option>
                                    <option value="3" selected>3 letters</option>
                                    <option value="4">4 letters</option>
                                    <option value="5">5 letters</option>
                                </select>
                                <button id="rhyme-btn" class="btn btn-secondary mt-2">Search</button>
                                <div class="slider-container">
                                    <label for="length-slider">Max Word Length: <span id="slider-value">0</span></label>
                                    <input type="range" id="length-slider" class="form-control-range" min="1" max="1" value="1" disabled>
                                </div>
                                <div id="rhymes-list" class="mt-2"></div>
                            </div>
                        </div>

                        <div class="separator"></div>
                        <!-- Libraries Buttons -->
                        <div>
                            <h5 class="text-center" data-toggle="tooltip" data-placement="top" title="This is a knowledge base where you can read more about how to use Udio. More to come soon.">Libraries</h5>
                            <button id="cheat-sheet-btn" class="btn btn-info mb-3">Tags cheat-sheet</button>
                            <!-- Cheat Sheet Modal -->
                            <div class="modal fade" id="cheatSheetModal" tabindex="-1" role="dialog" aria-labelledby="cheatSheetModalLabel" aria-hidden="true">
                              <div class="modal-dialog modal-xl" role="document">
                                <div class="modal-content">
                                  <div class="modal-header">
                                    <h5 class="modal-title" id="cheatSheetModalLabel">Cheat-sheet</h5>
                                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                      <span aria-hidden="true">&times;</span>
                                    </button>
                                  </div>
                                  <div class="modal-body">
        
                                    <h3>Official tags</h3>
                                    <table class="table">
                                        <thead>
                                            <tr>
                                                <th>Tag</th>
                                                <th>Explanation</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td class="tag-cell">[Verse]</td>
                                                <td>Main narrative section of a song.</td>
                                            </tr>
                                            <tr>
                                                <td class="tag-cell">[Chorus]</td>
                                                <td>Repetitive, catchy section that often contains the song's hook</td>
                                            </tr>
                                            <tr>
                                                <td class="tag-cell">[Intro]</td>
                                                <td>Opening section that sets the tone of the song</td>
                                            </tr>
                                            <tr>
                                                <td class="tag-cell">[Outro]</td>
                                                <td>Closing section that brings the song to an end</td>
                                            </tr>
                                            <tr>
                                                <td class="tag-cell">[Bridge]</td>
                                                <td>Contrasting section that connects two main parts of a song</td>
                                            </tr>
                                            <tr>
                                                <td class="tag-cell">[Hook]</td>
                                                <td>Catchy phrase or riff designed to grab the listener's attention</td>
                                            </tr>
                                            <tr>
                                                <td class="tag-cell">[Pre-chorus]</td>
                                                <td>Section that builds tension before the chorus</td>
                                            </tr>
                                            <tr>
                                                <td class="tag-cell">[Refrain]</td>
                                                <td>Repeated lyrical phrase or musical idea</td>
                                            </tr>
                                            <tr>
                                                <td class="tag-cell">[Post-chorus]</td>
                                                <td>Section that follows and extends the chorus</td>
                                            </tr>
                                            <tr>
                                                <td class="tag-cell">[Drop]</td>
                                                <td>Moment of musical climax, often in electronic dance music</td>
                                            </tr>
                                            <tr>
                                                <td class="tag-cell">[Interlude]</td>
                                                <td>Instrumental passage between other sections</td>
                                            </tr>
                                            <tr>
                                                <td class="tag-cell">[Instrumental Break]</td>
                                                <td>Section without vocals, showcasing instruments</td>
                                            </tr>
                                            <tr>
                                                <td class="tag-cell">[Instrumental]</td>
                                                <td>Piece or section of music without vocals</td>
                                            </tr>
                                            <tr>
                                                <td class="tag-cell">[Build]</td>
                                                <td>Gradual increase in intensity or complexity</td>
                                            </tr>
                                            <tr>
                                                <td class="tag-cell">[Pre-hook]</td>
                                                <td>Section that leads into the hook</td>
                                            </tr>
                                            <tr>
                                                <td class="tag-cell">[Pre-drop]</td>
                                                <td>Build-up section before the drop in electronic music</td>
                                            </tr>
                                            <tr>
                                                <td class="tag-cell">[Pre-refrain]</td>
                                                <td>Section leading into the refrain</td>
                                            </tr>
                                            <tr>
                                                <td class="tag-cell">[Break]</td>
                                                <td>Brief pause or change in the rhythm or melody</td>
                                            </tr>
                                            <tr>
                                                <td class="tag-cell">[All]</td>
                                                <td>Indicates all instruments or voices playing together</td>
                                            </tr>
                                            <tr>
                                                <td class="tag-cell">[Breakdown]</td>
                                                <td>Stripped-down section that contrasts with fuller sections</td>
                                            </tr>
                                            <tr>
                                                <td class="tag-cell">[Instrumental Bridge]</td>
                                                <td>Bridge section without vocals</td>
                                            </tr>
                                            <tr>
                                                <td class="tag-cell">[Sample]</td>
                                                <td>Use of a portion of another sound recording</td>
                                            </tr>
                                            <tr>
                                                <td class="tag-cell">[Solo]</td>
                                                <td>Section featuring a single instrument or voice</td>
                                            </tr>
                                            <tr>
                                                <td class="tag-cell">[Ensemble]</td>
                                                <td>Section featuring multiple instruments or voices together</td>
                                            </tr>
                                            <tr>
                                                <td class="tag-cell">[Post-hook]</td>
                                                <td>Section that follows and extends the hook</td>
                                            </tr>
                                            <tr>
                                                <td class="tag-cell">[Spoken Word]</td>
                                                <td>Poetic or prose section that is spoken rather than sung</td>
                                            </tr>
                                            <tr>
                                                <td class="tag-cell">[Choir]</td>
                                                <td>Section featuring a group of singers</td>
                                            </tr>
                                            <tr>
                                                <td class="tag-cell">[Announcer]</td>
                                                <td>Spoken introduction or commentary, often in live recordings</td>
                                            </tr>
                                        </tbody>
                                    </table>

                                    <br>

                                    <h3>Community tags</h3>
                                    <table class="table">
                                        <thead>
                                            <tr>
                                                <th>Tag</th>
                                                <th>Explanation</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td class="tag-cell">[Verse: Male Vocalist]</td>
                                                <td>Specifies that the verse should be sung by a male vocalist. (Not always honored)</td>
                                            </tr>
                                            <tr>
                                                <td class="tag-cell">[Verse: Female Vocalist]</td>
                                                <td>Specifies that the verse should be sung by a female vocalist. (Not always honored)</td>
                                            </tr>
                                            <tr>
                                                <td class="tag-cell">[Final Chorus]</td>
                                                <td>The last iteration of the chorus, often with added intensity or slight variations to emphasize the conclusion of the song.</td>
                                            </tr>
                                            <tr>
                                                <td class="tag-cell">[Build-Up]</td>
                                                <td>Similar to the [Pre-Chorus], but not necessarily leading into a chorus. It gradually increases intensity, setting up any major transition in the song.</td>
                                            </tr>
                                            <tr>
                                                <td class="tag-cell">[Breakdown]</td>
                                                <td>A section where the instrumentation or energy is reduced, often to build tension before a subsequent section.</td>
                                            </tr>
                                            <tr>
                                                <td class="tag-cell">[Verse Repeat]</td>
                                                <td>A repeated verse, usually with the same melody and lyrics as an earlier verse.</td>
                                            </tr>
                                            <tr>
                                                <td class="tag-cell">[Chorus Repeat]</td>
                                                <td>The chorus being repeated after another section.</td>
                                            </tr>
                                            <tr>
                                                <td class="tag-cell">[Instrumental Outro]</td>
                                                <td>A closing section with only instruments, no vocals.</td>
                                            </tr>
                                            <tr>
                                                <td class="tag-cell">[Voiceover]</td>
                                                <td>A spoken part added over the instrumental or vocal sections.</td>
                                            </tr>
                                            <tr>
                                                <td class="tag-cell">[Spoken]</td>
                                                <td>Lyrics delivered as spoken word rather than sung.</td>
                                            </tr>
                                            <tr>
                                                <td class="tag-cell">[Hook Repeat]</td>
                                                <td>Repetition of the hook, often found in the chorus or refrain.</td>
                                            </tr>
                                            <tr>
                                                <td class="tag-cell">[Couplet]</td>
                                                <td>Two lines of lyrics that typically rhyme and form a unit in a verse.</td>
                                            </tr>
                                            <tr>
                                                <td class="tag-cell">[Pre-Break]</td>
                                                <td>A section that precedes a break in the song, often building tension.</td>
                                            </tr>
                                            <tr>
                                                <td class="tag-cell">[Emotional]</td>
                                                <td>Used to indicate when the singer should deliver a heightened emotional performance, often by intensifying or emphasizing the last word of a line, like a scream or powerful vocal push.</td>
                                            </tr>
                                            <tr>
                                                <td class="tag-cell">(lyrics in parentheses)</td>
                                                <td>Use parentheses to indicate lyrics sung in a different manner, including words or sounds (e.g., “ooohhh”).</td>
                                            </tr>
                                        </tbody>
                                    </table>

                                  </div>
                                  <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                                  </div>
                                </div>
                              </div>
                            </div>

                            <!-- Example Button -->
                            <button style="display:none;" id="example-btn" class="btn btn-info mb-3">Example</button>
                            <!-- Example Modal -->
                            <div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
                              <div class="modal-dialog modal-xl" role="document">
                                <div class="modal-content">
                                  <div class="modal-header">
                                    <h5 class="modal-title" id="exampleLabel">Example Song</h5>
                                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                      <span aria-hidden="true">&times;</span>
                                    </button>
                                  </div>
                                  <div class="modal-body">
                                    <p>Example</p>
     
                                  </div>
                                  <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                                  </div>
                                </div>
                              </div>
                            </div>
                        </div>
                    </div>
                </div> <!-- End of row -->
            </div>
        </div>
    </div>
    <!-- Include jQuery and Bootstrap JS for modal functionality -->
    <script src="https://code.jquery.com/jquery-3.5.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js"></script>
    
    <!-- Include the word list script -->
    <script src="wordlist.js"></script>

    <!-- Include the blacklist script -->
    <script src="blacklist.js"></script>

    <!-- Include the tags for pop-up -->
    <script src="popup-tags.js"></script>

    <!-- JavaScript Code -->

    <!-- Text-to-speech -->
    <script>
        let voices = [];
        let selectedVoiceIndex = null; // Store the selected voice index

        // Load voices into the dropdowns
        function loadVoices() {
            voices = speechSynthesis.getVoices();
            const languageSelect = document.getElementById('languageSelect');
            const voiceSelect = document.getElementById('voiceSelect');

            const uniqueLanguages = Array.from(new Set(voices.map(voice => voice.lang)));

            // Populate language dropdown
            languageSelect.innerHTML = '';
            uniqueLanguages.forEach(language => {
                const option = document.createElement('option');
                option.value = language;
                option.textContent = language;
                languageSelect.appendChild(option);
            });

            // Trigger voice list update when a language is selected
            languageSelect.addEventListener('change', updateVoicesByLanguage);

            // Update the voices dropdown based on initial language selection
            updateVoicesByLanguage();
        }

        // Update voices based on selected language
        function updateVoicesByLanguage() {
            const languageSelect = document.getElementById('languageSelect');
            const selectedLanguage = languageSelect.value;

            const voiceSelect = document.getElementById('voiceSelect');

            // Save the current selected voice index before updating the list
            const previouslySelectedIndex = voiceSelect.selectedIndex;

            voiceSelect.innerHTML = '';  // Clear previous options

            const filteredVoices = voices.filter(voice => voice.lang === selectedLanguage);

            filteredVoices.forEach((voice, index) => {
                const option = document.createElement('option');
                option.value = voices.indexOf(voice); // Save the global index
                option.textContent = `${voice.name} (${voice.lang})`;
                voiceSelect.appendChild(option);
            });

            // Restore the selected option
            if (previouslySelectedIndex !== -1 && previouslySelectedIndex < voiceSelect.options.length) {
                voiceSelect.selectedIndex = previouslySelectedIndex;
            } else if (filteredVoices.length > 0) {
                // Default to the first voice if none is selected
                voiceSelect.selectedIndex = 0;
            }
        }

        // Ensure the voices are loaded when available
        window.speechSynthesis.onvoiceschanged = loadVoices;

        // Function to get selected text or full text
        function getSelectedText() {
            const textarea = document.getElementById('lyric-input');
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;

            // If there is selected text, return it; otherwise return full text
            let text = start !== end ? textarea.value.substring(start, end) : textarea.value;

            // Use regular expression to remove text within [] and ()
            text = text.replace(/\[.*?\]|\(.*?\)/g, '');

            return text;
        }

        // Function to update status message
        function updateStatus(message, color = 'green') {
            const statusElement = document.getElementById('status');
            statusElement.textContent = message;
            statusElement.style.color = color;
        }

        // Update rate value display
        document.getElementById('rateControl').addEventListener('input', function() {
            document.getElementById('rateValue').textContent = this.value;
        });

        function speakText() {
            // Stop any ongoing speech to prevent interruptions
            if (speechSynthesis.speaking) {
                speechSynthesis.cancel();
            }

            const text = getSelectedText();
            if (text.trim() === '') return;  // Don't speak empty text

            // Split text into chunks if necessary
            const chunkSize = 200;  // Example chunk size
            const chunks = text.match(new RegExp(`.{1,${chunkSize}}`, 'g'));

            let chunkIndex = 0;

            // Get the selected voice once and store its global index
            const voiceSelect = document.getElementById('voiceSelect');
            selectedVoiceIndex = voiceSelect.selectedIndex; // Store the current index
            const selectedVoice = voices[voiceSelect.value];

            function speakChunk() {
                if (chunkIndex >= chunks.length) {
                    updateStatus('Speech finished.', 'blue');
                    document.getElementById('cancelButton').disabled = true;  // Disable cancel button
                    return;
                }

                const utterance = new SpeechSynthesisUtterance(chunks[chunkIndex]);

                // Explicitly set the selected voice each time
                utterance.voice = selectedVoice;

                // Set the speech rate based on the slider
                const rateControl = document.getElementById('rateControl');
                utterance.rate = rateControl.value;

                // Handle events
                utterance.onstart = function() {
                    updateStatus('Speaking...', 'green');
                    document.getElementById('cancelButton').disabled = false;  // Enable cancel button
                };

                utterance.onend = function () {
                    chunkIndex++;
                    speakChunk();  // Speak the next chunk
                };

                utterance.onerror = function(e) {
                    updateStatus('Stopped: ' + e.error, 'red');
                    document.getElementById('cancelButton').disabled = true;  // Disable cancel button
                };

                speechSynthesis.speak(utterance);
            }

            speakChunk();
        }

        function cancelSpeech() {
            if (speechSynthesis.speaking) {
                speechSynthesis.cancel();
                updateStatus('Speech canceled.', 'red');
                document.getElementById('cancelButton').disabled = true;  // Disable cancel button
            }
        }
    </script>

    <!-- Tags pop-up -->
    <script>
        $(document).ready(function() {

            var selectedTagIndex = -1;
            var insertPosition = -1; // Position where '/' was typed
            var filteredTagOptions = [];


            // Event listener for keyup on '#lyric-input'
            $('#lyric-input').on('keyup', function(event) {
                // Ignore keys that shouldn't trigger the popup refresh
                if (['ArrowUp', 'ArrowDown', 'Enter', 'Escape'].includes(event.key)) {
                    return;
                }
                var textarea = $(this)[0];
                var position = textarea.selectionStart;
                var text = textarea.value;

                // Search backwards from the cursor for the last '/'
                var slashPosition = text.lastIndexOf('/', position - 1);
                if (slashPosition >= 0) {
                    // Get the filter text
                    var filterText = text.substring(slashPosition + 1, position);
                    showTagPopup(slashPosition, filterText);
                } else {
                    hideTagPopup();
                }
            });


            // Close button for the tag popup
            $('#tag-popup-close').on('click', function() {
                hideTagPopup();
            });

            // Function to show the tag selection popup
            function showTagPopup(position, filterText) {
                // Filter the tagOptions based on filterText
                filteredTagOptions = tagOptions.filter(function(option) {
                    return option.tag.toLowerCase().includes(filterText.toLowerCase());
                });

                // If no options, hide the popup
                if (filteredTagOptions.length === 0) {
                    hideTagPopup();
                    return;
                }

                // Populate the tag list
                var $tagList = $('#tag-list');
                $tagList.empty();
                filteredTagOptions.forEach(function(option, index) {
                    var $item = $('<li class="list-group-item list-group-item-action"></li>');
                    $item.html('<strong>' + option.tag + '</strong><br><small>' + option.description + '</small>');
                    $item.on('click', function() {
                        var textarea = $('#lyric-input')[0];
                        var cursorPosition = textarea.selectionStart;
                        insertTagAtPosition(option.tag, position, cursorPosition);
                        hideTagPopup();
                    });
                    $item.on('mouseenter', function() {
                        // Update selectedTagIndex
                        selectedTagIndex = index;
                        updateTagSelection();
                    });
                    $tagList.append($item);
                });

                selectedTagIndex = 0; // Initialize selected index
                updateTagSelection(); // Update the highlighting
                insertPosition = position; // Store the position of '/'

                // Position the tag-popup
                var $textarea = $('#lyric-input');
                var offset = $textarea.offset();
                var textareaHeight = $textarea.outerHeight();
                var textareaWidth = $textarea.outerWidth();

                // Compute line number
                var textareaElem = $textarea[0];
                var textUpToPosition = textareaElem.value.substring(0, position + 1); // Include the '/'
                var lines = textUpToPosition.split('\n');
                var lineNumber = lines.length - 1;

                // Compute line height
                var lineHeight = parseInt($textarea.css('line-height'));
                if (isNaN(lineHeight)) {
                    var fontSize = parseInt($textarea.css('font-size'));
                    var lineHeightMultiplier = parseFloat($textarea.css('line-height'));
                    if (isNaN(lineHeightMultiplier)) {
                        lineHeightMultiplier = 1.2; // Default line height
                    }
                    lineHeight = fontSize * lineHeightMultiplier;
                }

                // Adjust for padding
                var paddingTop = parseInt($textarea.css('padding-top'));

                // Compute the top position
                var topPosition = paddingTop + (lineNumber * lineHeight) - $textarea.scrollTop();

                // Adjust left position to align with the left edge of the textarea
                var leftPosition = "70px";

                // Position the popup over the textarea, just below the line where '/' was typed
                $('#tag-popup').css({
                    top: topPosition + lineHeight, // Position below the line
                    left: leftPosition
                }).show();
            }

            // Function to hide the tag popup
            function hideTagPopup() {
                $('#tag-popup').hide();
                insertPosition = -1;
                selectedTagIndex = -1;
                $('#tag-list').empty(); // Clear the list to prevent duplication
                filteredTagOptions = [];
            }

            // Function to update the selected item in the tag list
            function updateTagSelection() {
                var $items = $('#tag-list .list-group-item');
                $items.removeClass('tag-active');
                if (selectedTagIndex >= 0 && selectedTagIndex < $items.length) {
                    var $selectedItem = $items.eq(selectedTagIndex);
                    $selectedItem.addClass('tag-active');
                    // Scroll into view if necessary
                    var tagList = $('#tag-list');
                    var itemTop = $selectedItem.position().top;
                    var itemBottom = itemTop + $selectedItem.outerHeight();
                    if (itemBottom > tagList.height()) {
                        tagList.scrollTop(tagList.scrollTop() + itemBottom - tagList.height());
                    } else if (itemTop < 0) {
                        tagList.scrollTop(tagList.scrollTop() + itemTop);
                    }
                }
            }

            // Function to insert the selected tag at the correct position
            function insertTagAtPosition(tag, startPosition, endPosition) {
                var textarea = $('#lyric-input')[0];
                var text = textarea.value;
                // Replace the text from startPosition to endPosition with the tag
                var before = text.substring(0, startPosition);
                var after = text.substring(endPosition);
                var newText = before + tag + after;

                var newCursorPos = startPosition + tag.length;

                textarea.value = newText;
                textarea.selectionStart = textarea.selectionEnd = newCursorPos;
                textarea.focus();

                // Trigger input event to update highlighting and counters
                $('#lyric-input').trigger('input');
            }

            // Hide the tag popup when clicking outside or pressing ESC
            $(document).on('click', function(event) {
                if (!$(event.target).closest('#tag-popup, #lyric-input').length) {
                    hideTagPopup();
                }
            });

            // Keydown event handler for keyboard navigation
            $(document).on('keydown', function(event) {
                if ($('#tag-popup').is(':visible')) {
                    if (event.key === 'ArrowDown') {
                        event.preventDefault(); // prevent cursor movement
                        selectedTagIndex = (selectedTagIndex + 1) % filteredTagOptions.length;
                        updateTagSelection();
                    } else if (event.key === 'ArrowUp') {
                        event.preventDefault(); // prevent cursor movement
                        selectedTagIndex = (selectedTagIndex - 1 + filteredTagOptions.length) % filteredTagOptions.length;
                        updateTagSelection();
                    } else if (event.key === 'Enter') {
                        event.preventDefault(); // prevent form submission or new line
                        if (selectedTagIndex >= 0 && selectedTagIndex < filteredTagOptions.length) {
                            var option = filteredTagOptions[selectedTagIndex];
                            var textarea = $('#lyric-input')[0];
                            var cursorPosition = textarea.selectionStart;
                            insertTagAtPosition(option.tag, insertPosition, cursorPosition);
                            hideTagPopup();
                        }
                    } else if (event.key === 'Escape') {
                        hideTagPopup();
                    }
                } else {
                    if (event.key === 'Escape') {
                        hideTagPopup();
                    }
                }
            });

            // Close button for the tag popup (if you have one)
            $('#tag-popup-close').on('click', function() {
                hideTagPopup();
            });
        });
    </script>

    <!-- General JavaScript -->
    <script>
        $(document).ready(function() {
            $('[data-toggle="tooltip"]').tooltip();


            // Handle Cheat-sheet Modal
            $('#cheat-sheet-btn').click(function() {
                $('#cheatSheetModal').modal('show');
            });

            // Handle Example Modal
            $('#example-btn').click(function() {
                $('#exampleModal').modal('show');
            });

            // Spell Check Toggle
            $('#spellcheck-toggle').change(function() {
                if ($(this).is(':checked')) {
                    $('#lyric-input').attr('spellcheck', 'true');
                } else {
                    $('#lyric-input').attr('spellcheck', 'false');
                }
            });

            // Initialize spellcheck attribute based on the checkbox state
            $('#lyric-input').attr('spellcheck', 'false'); // Default is off

            // Generate suggestions based on tempo
            function updateSuggestions() {
                var tempo = $('#tempo-select').val();
                var suggestions = '';
                if (tempo === 'slow') {
                    suggestions = '<pre>Prompt suggestions: Tempo 60 BPM, Ballads, Blues, Lo-Fi Hip-Hop, Downtempo, soulful melodies, emotional or introspective lyrics.</pre>';
                } else if (tempo === 'mid') {
                    suggestions = '<pre>Prompt suggestions: Tempo 100 BPM, Pop, Hip-Hop, Reggaeton, R&B, Funk, groovy rhythms, catchy hooks, storytelling, uplifting or reflective messages.</pre>';
                } else if (tempo === 'fast') {
                    suggestions = '<pre>Prompt suggestions: Tempo 140 BPM, Rap, EDM, Drum and Bass, Punk Rock, Techno, fast-paced beats, energetic melodies, dance vibes, high-energy anthems.</pre>';
                }
                $('#suggestions').html(suggestions);
            }

            function updateLineWordCounts() {
                var text = $('#lyric-input').val();
                var lines = text.split('\n');
                var lineCountsHtml = '';
                var totalLines = lines.length;

                for (var i = 0; i < totalLines; i++) {
                    var line = lines[i];
                    // Remove content within [] and ()
                    var lineWithoutBrackets = line.replace(/\[[^\]]*\]|\([^\)]*\)/g, '').trim();

                    // Split the line into words
                    var wordsInLine = lineWithoutBrackets.split(/\s+/).filter(function(word) {
                        return word.length > 0;
                    }).length;

                    // If wordsInLine is zero, display an empty string
                    var displayCount = wordsInLine > 0 ? wordsInLine : '';

                    lineCountsHtml += '<span class="line-count">' + displayCount + '</span>\n';
                }

                $('#line-word-counts').html(lineCountsHtml);
            }

            // Synchronize scroll positions
            function synchronizeScroll() {
                requestAnimationFrame(function() {
                    var scrollTop = $('#lyric-input').scrollTop();
                    var scrollLeft = $('#lyric-input').scrollLeft();
                    $('#highlighted-text').scrollTop(scrollTop);
                    $('#highlighted-text').scrollLeft(scrollLeft);
                    $('#line-word-counts').scrollTop(scrollTop);
                });
            }

            // Event listeners
            $('#lyric-input').on('input', function() {
                updateHighlighting();
                updateCounters();
                updateLineWordCounts();
            });

            $('#lyric-input').on('scroll', function() {
                synchronizeScroll();
            });


            // Synchronize scroll between textarea and highlighted text
            $('#lyric-input').on('scroll', function() {
                $('#highlighted-text').scrollTop($(this).scrollTop());
                $('#highlighted-text').scrollLeft($(this).scrollLeft());
            });

            // Calculate word chunks based on duration and tempo
            function updateHighlighting() {
                var duration = $('#duration-select').val();
                var tempo = $('#tempo-select').val();
                var wordsPerChunk = 0;

                if (tempo === 'slow') {
                    wordsPerChunk = (duration == '32') ? 30 : 120;
                } else if (tempo === 'mid') {
                    wordsPerChunk = (duration == '32') ? 75 : 300;
                } else if (tempo === 'fast') {
                    wordsPerChunk = (duration == '32') ? 140 : 560;
                }

                var text = $('#lyric-input').val();
                var words = text.split(/(\s+)/); // Split including whitespace
                var displayText = '';
                var chunkCount = 0;
                var wordCount = 0;
                var inTag = false;

                for (var i = 0; i < words.length; i++) {
                    var word = words[i];

                    // Check if it's whitespace
                    if (/^\s+$/.test(word)) {
                        displayText += word;
                        continue;
                    }

                    // Check for tags and set inTag flag
                    if (word.startsWith('[') || word.startsWith('(')) {
                        inTag = true;
                    }

                    if (inTag) {
                        displayText += word;
                    } else {
                        if (word.trim().length > 0) {
                            wordCount++;
                            if (wordCount > wordsPerChunk) {
                                chunkCount++;
                                wordCount = 1;
                            }
                            var highlightClass = (chunkCount % 2 == 0) ? 'highlight1' : 'highlight2';

                            // Check if the word is in the blacklist
                            var cleanedWord = word.replace(/[^\w\s]|_/g, "").replace(/\s+/g, "").toLowerCase();
                            if (blacklist.includes(cleanedWord)) {
                                highlightClass += ' highlight-blacklist';
                            }

                            displayText += '<span class="' + highlightClass + '">' + word + '</span>';
                        } else {
                            displayText += word;
                        }
                    }

                    if (word.endsWith(']') || word.endsWith(')')) {
                        inTag = false;
                    }

                    displayText = displayText.replace(/\n$/, '\n&nbsp;');
                }

                $('#highlighted-text').html(displayText);

                // Force repaint
                $('#highlighted-text').css('transform', 'translateZ(0)');

                // Synchronize scroll positions after updating content
                synchronizeScroll();
            }

            // Update word and letter counters
            function updateCounters() {
                var text = $('#lyric-input').val();
                var words = text.split(/(\s+)/); // Split including whitespace
                var wordCount = 0;
                var letterCount = 0;
                var inTag = false;

                for (var i = 0; i < words.length; i++) {
                    var word = words[i];

                    // Check if it's whitespace
                    if (/^\s+$/.test(word)) {
                        continue;
                    }

                    // Check for tags and set inTag flag
                    if (word.startsWith('[') || word.startsWith('(')) {
                        inTag = true;
                    }

                    if (!inTag) {
                        if (word.trim().length > 0) {
                            wordCount++;
                            letterCount += word.length;
                        }
                    }

                    if (word.endsWith(']') || word.endsWith(')')) {
                        inTag = false;
                    }
                }

                $('#word-count').text(wordCount);
                $('#letter-count').text(letterCount);
            }

            // Event listeners
            $('#tempo-select, #duration-select').change(function() {
                updateSuggestions();
                updateHighlighting();
            });

            $('#lyric-input').on('input', function() {
                updateHighlighting();
                updateCounters();
            });

            // Initialize
            updateSuggestions();
            updateHighlighting();
            updateCounters();
            updateLineWordCounts();

            // Save Button Functionality
            $('#save-btn').click(function() {
                var title = $('#title-input').val();
                var prompt = $('#prompt-input').val();
                var lyrics = $('#lyric-input').val();
                var duration = $('#duration-select').val();
                var tempo = $('#tempo-select').val();

                if (title.trim() === '') {
                    alert('Please enter a title before saving.');
                    return;
                }

                // Get current date/time in US format
                var now = new Date();
                var options = { 
                    year: 'numeric', 
                    month: '2-digit', 
                    day: '2-digit', 
                    hour: '2-digit', 
                    minute: '2-digit', 
                    second: '2-digit', 
                    hour12: true 
                };
                var formattedDate = now.toLocaleString('en-US', options);
                
                // Add the timestamp to the data
                var data = {
                    title: title,
                    prompt: prompt,
                    lyrics: lyrics,
                    duration: duration,
                    tempo: tempo,
                    timestamp: formattedDate // Add the date/time to the JSON data
                };

                var dataStr = JSON.stringify(data, null, 2);
                var blob = new Blob([dataStr], { type: "application/json" });
                var url = URL.createObjectURL(blob);

                // Append the formatted date to the file name
                var formattedDateForFileName = now.toISOString().slice(0, 19).replace(/[:T]/g, '-'); // yyyy-mm-dd-hh-mm-ss
                var a = document.createElement('a');
                a.href = url;
                a.download = title.replace(/\s+/g, '_') + '_' + formattedDateForFileName + '.json';
                a.click();
                URL.revokeObjectURL(url);
            });


            // Load Button Functionality
            $('#load-btn').click(function() {
                $('#load-input').click();
            });

            // Load Functionality
            $('#load-input').change(function(event) {
                var file = event.target.files[0];
                if (!file) {
                    return;
                }

                var reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        var data = JSON.parse(e.target.result);
                        $('#title-input').val(data.title || '');
                        $('#prompt-input').val(data.prompt || '');
                        $('#lyric-input').val(data.lyrics || '');
                        $('#duration-select').val(data.duration || '32');
                        $('#tempo-select').val(data.tempo || 'slow');

                        updateSuggestions();
                        updateHighlighting();
                        updateCounters();
                        updateLineWordCounts();
                    } catch (err) {
                        alert('Invalid file format.');
                    }
                };
                reader.readAsText(file);
            });

            // Rhyme Finder Functionality
             var currentRhymes = []; // Store current rhymes for filtering

            function loadWordList(callback) {
                if (wordListLoaded) {
                    callback();
                    return;
                }
                $.ajax({
                    url: 'words.txt', // Path to your words.txt file
                    dataType: 'text',
                    success: function(data) {
                        wordList = data.split(/\r?\n/);
                        wordListLoaded = true;
                        callback();
                    },
                    error: function() {
                        alert('Failed to load word list.');
                    }
                });
            }

            function displayRhymes(rhymes, maxLength) {
                var filteredRhymes = rhymes.filter(function(word) {
                    return word.length <= maxLength;
                });

                if (filteredRhymes.length === 0) {
                    $('#rhymes-list').html('<p>No rhymes found.</p>');
                } else {
                    var rhymesHtml = '<ol>';
                    filteredRhymes.forEach(function(word) {
                        var link = 'https://www.oed.com/search/dictionary/?scope=Entries&q=' + encodeURIComponent(word);
                        rhymesHtml += '<li><a href="' + link + '" target="_blank">' + word + '</a></li>';
                    });
                    rhymesHtml += '</ol>';
                    $('#rhymes-list').html(rhymesHtml);
                }
            }

            $('#rhyme-btn').click(function() {
                var inputWord = $('#rhyme-input').val().trim().toLowerCase();
                if (inputWord.length < 2) {
                    $('#rhymes-list').html('<p>Please enter a word with at least 2 letters.</p>');
                    return;
                }

                var endingLength = parseInt($('#ending-select').val());
                if (inputWord.length < endingLength) {
                    $('#rhymes-list').html('<p>The word is shorter than the selected ending length.</p>');
                    return;
                }

                var ending = inputWord.slice(-endingLength); // Get last N letters
                currentRhymes = wordList.filter(function(word) {
                    return word.endsWith(ending) && word !== inputWord;
                });

                if (currentRhymes.length === 0) {
                    $('#rhymes-list').html('<p>No rhymes found.</p>');
                    $('#length-slider').prop('disabled', true);
                    $('#slider-value').text('0');
                    $('#length-slider').val(1);
                } else {
                    // Get the length of the longest word
                    var maxWordLength = Math.max.apply(null, currentRhymes.map(function(word) {
                        return word.length;
                    }));

                    // Set up the slider
                    $('#length-slider').attr('min', 1);
                    $('#length-slider').attr('max', maxWordLength);
                    $('#length-slider').val(maxWordLength);
                    $('#length-slider').prop('disabled', false);
                    $('#slider-value').text(maxWordLength);

                    // Display rhymes
                    displayRhymes(currentRhymes, maxWordLength);
                }
            });


            // Slider event listener
            $('#length-slider').on('input change', function() {
                var maxLength = parseInt($(this).val());
                $('#slider-value').text(maxLength);
                displayRhymes(currentRhymes, maxLength);
            });
        });
    </script>
</body>
</html>
